<!DOCTYPE html>
<html style="background-image: url('assets/images/background3.jpg');background-size: 100% 100%;">
<head>
    <title>Quizspin : You need smarts. And a little luck.</title>
    <!--<link href='http://fonts.googleapis.com/css?family=Finger+Paint' rel='stylesheet' type='text/css'>-->
    <!--<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">-->
    <!--<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">-->

    <!--<link data-turbolinks-track="true" href="/assets/application-6f56d32729ceb85b1726a9b451767a38.css" media="all" rel="stylesheet" />-->
    <link rel="stylesheet" href="assets/css/home.css">
    <link rel="stylesheet" href="assets/css/slots.css">

    <script data-turbolinks-track="true" src="/assets/application-0c0b30743dd661345d98718425add4a3.js"></script>
    <!--<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>-->
    <script src="assets/js/jquery-1.11.0.min.js"></script>
    <script src="assets/js/jquery.easing.1.3.min.js"></script>
    <script src="assets/js/jquery.jSlots.min.js"></script>
    <script src="assets/js/mygonJSON.js"></script>


    <meta content="authenticity_token" name="csrf-param"/>
    <meta content="Kwf3/xXQRNfNHRCgHBVzrwQ1v5K5Eha3G9/fNPLPfEg=" name="csrf-token"/>
    <script type="text/javascript">

        //<![CDATA[
        window.gon = {};
        gon.winners = [
            [3, 3, 120],
            [3, 2, 60],
            [3, 1, 30],
            [4, 3, 100],
            [4, 2, 50],
            [4, 1, 20],
            [5, 3, 80],
            [5, 2, 40],
            [6, 3, 60],
            [6, 2, 30],
            [7, 3, 40],
            [7, 2, 20]
        ];
        gon.bonus_image = "assets/images/bonus.png";
        gon.qmark_image = "assets/images/qmark.png";
        gon.iconcounts = [7, 3];
        gon.maxweight = 2;
        gon.credits = 10135;
        gon.cost = 10;
        gon.userid = 32;
        //]]>
    </script>
</head>
<body>
<style>
    .slots li {
        background-image: url(assets/images/sunrise-indi.jpg);
    }
</style>
<div id="wrapper">
<img alt="Spinclick" id="spinclick" src="assets/images/spinclick.png"/>

<div id="machine-half">
    <div id="machine">
        <img alt="Machine2" id="machine-image" src="assets/images/machine2.png"/>

        <div id="handle-wrapper">
            <img alt="Handle" id="slot-handle" src="assets/images/handle.png"/>
        </div>
        <div id="slots-panel">
            <ul class="slots">
                <li style="background-color:black">
                    <span><img alt="Qmark" class="questioner" src="assets/images/qmark.png"/></span>
                </li>
                <li style="background-color:black">
                    <span><img alt="Qmark" class="questioner" src="assets/images/qmark.png"/></span>
                </li>
                <li style="background: ">
                    <span><img alt="Backpack" src="assets/images/backpack.png"/></span>
                </li>
                <li style="background: ">
                    <span><img alt="Explorer" src="assets/images/explorer.png"/></span>
                </li>
                <li style="background: ">
                    <span><img alt="Scuba" src="assets/images/scuba.png"/></span>
                </li>
                <li style="background: ">
                    <span><img alt="Surf" src="assets/images/surf.png"/></span>
                </li>
                <li style="background: ">
                    <span><img alt="Mountaineer" src="assets/images/mountaineer.png"/></span>
                </li>
                <li style="background: ">
                    <span><img alt="Scuba" src="assets/images/scuba.png"/></span>
                </li>
                <li style="background: ">
                    <span><img alt="Surf" src="assets/images/surf.png"/></span>
                </li>
                <li style="background: ">
                    <span><img alt="Mountaineer" src="assets/images/mountaineer.png"/></span>
                </li>
            </ul>
            <img alt="Over" id="slotOverlay" src="assets/images/over.png"/>
        </div>
    </div>
</div>
<div id="matter-half">
    <div id="header-panel">
        <img alt="Logo" id="logo" src="assets/images/logo.png"/>
        <br/>

        <div id="credits">
            <div id="creditsVal"></div>
            <div id="creditsLabel">GEOCOINS</div>
        </div>
    </div>
    <div id="matter-panel">
        <div id="base-panel">
            <img alt="Panelbackground" id="intro-back" src="assets/images/panelbackground.png"/>
        </div>
        <div id="intro-panel" class="content-panel">
            <img alt="Panelbackground" id="intro-back" src="assets/images/panelbackground.png"/>

            <div id="intro-text">
                <img alt="Natgeologo" id="gamelogo"
                     src="assets/images/natgeologo.jpg"/>
                <br/>
                <br/>
                Welcome to Natgeo Quizspin! <br/><br/> Spin the slots to try your luck. But as they say, you can
                make your own luck. Can you? Answer the questions to win big and leave lady luck gasping...
            </div>
        </div>
        <div id="leaderboard-panel" class="content-panel">
            <img alt="Panelbackground" id="leaderboard-back"
                 src="assets/images/panelbackground.png"/>

            <div id="leaderboard-table">
                <h1>Leaderboard</h1>
                <table>
                    <tr>
                        <th>Rank</th>
                        <th>User</th>
                        <th>Credits</th>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>venky@quizspin.com</td>
                        <td><span class="leader-credits">10135</span></td>

                    </tr>
                    <tr>
                        <td>2</td>
                        <td>swapnil@ptotem.com</td>
                        <td>3210</td>

                    </tr>
                </table>
            </div>
        </div>
        <div id="payoff-panel" class="content-panel">
            <img alt="Panelbackground" id="payoff-back"
                 src="assets/images/panelbackground.png"/>

            <div id="payoff-table">
                <h1>Payoff Table</h1>
                <table>
                    <tr>
                        <td>
                            <img alt="Backpack" src="assets/images/backpack.png"/>
                            <img alt="Backpack" src="assets/images/backpack.png"/>
                            <img alt="Backpack" src="assets/images/backpack.png"/>
                            <span id="backpack_3"> 120</span>
                        </td>
                        <td>
                            <img alt="Backpack" src="assets/images/backpack.png"/>
                            <img alt="Backpack" src="assets/images/backpack.png"/>
                            <span id="backpack_2"> 60</span>
                        </td>
                        <td>
                            <img alt="Backpack" src="assets/images/backpack.png"/>
                            <span id="backpack_1"> 30</span>
                        </td>
                    </tr>
                    <tr>
                        <td><img alt="Explorer" src="assets/images/explorer.png"/>
                            <img alt="Explorer" src="assets/images/explorer.png"/>
                            <img alt="Explorer" src="assets/images/explorer.png"/>
                            <span id="explorer_3"> 100</span>
                        </td>
                        <td><img alt="Explorer" src="assets/images/explorer.png"/>
                            <img alt="Explorer" src="assets/images/explorer.png"/>
                            <span id="explorer_2"> 50</span></td>
                        <td>
                            <img alt="Explorer" src="assets/images/explorer.png"/>
                            <span id="explorer_1"> 20</span>
                        </td>
                    </tr>
                    <tr>
                        <td><img alt="Scuba" src="assets/images/scuba.png"/>
                            <img alt="Scuba" src="assets/images/scuba.png"/>
                            <img alt="Scuba" src="assets/images/scuba.png"/>
                            <span id="scuba_3"> 80</span>
                        </td>
                        <td><img alt="Scuba" src="assets/images/scuba.png"/>
                            <img alt="Scuba" src=assets/images/scuba.png"/>
                            <span id="scuba_2"> 40</span>
                        </td>
                    </tr>
                    <tr>
                        <td><img alt="Surf" src="assets/images/surf.png"/>
                            <img alt="Surf" src="assets/images/surf.png"/>
                            <img alt="Surf" src="assets/images/surf.png"/>
                            <span id="surf_3"> 60</span>
                        </td>
                        <td><img alt="Surf" src="assets/images/surf.png"/>
                            <img alt="Surf" src="assets/images/surf.png"/>
                            <span id="surf_2"> 30</span>
                        </td>
                    </tr>
                    <tr>
                        <td><img alt="Mountaineer" src="assets/images/mountaineer.png"/>
                            <img alt="Mountaineer" src="assets/images/mountaineer.png"/>
                            <img alt="Mountaineer" src="assets/images/mountaineer.png"/>
                            <span id="mountaineer_3"> 40</span>
                        </td>
                        <td><img alt="Mountaineer" src="assets/images/mountaineer.png"/>
                            <img alt="Mountaineer" src="assets/images/mountaineer.png"/>
                            <span id="mountaineer_2"> 20</span>
                        </td>
                    </tr>
                </table>
                <p style="width:80%;font-weight: bold;">
                    <img alt="Qmark" class="qmark-payoff" src="assets/images/qmark.png"/>
                    Answer questions to win free spins.</p>
            </div>
        </div>
        <div id="profile-panel" class="content-panel">
            <img alt="Panelbackground" id="intro-back" src="assets/images/panelbackground.png"/>

            <div id="profile-text">
                <img alt="Ptotemnexus" src="/assets/ptotemnexus-a54ebec8ccad6dd908058a6d8f899903.png"/>
                <br/>
                Quizspin is a joint initiative by Ptotem and Nexus, designed to entertain while educating you.
                If you want to know more about our initiatives in Serious Gaming, please visit
                the <a class="about-link" href="http://www.ptotem.com">Ptotem</a> and
                the <a class="about-link" href="http://www.consultnexus.in">Nexus</a> websites
            </div>
        </div>
        <div id="quiz-panel" class="content-panel">
            <img alt="Panelbackground" id="quiz-back" src="assets/images/panelbackground.png"/>

            <div id="quiz-content" class="questioned">
                <div id="qquestion"></div>
                <div id="qid"></div>
                <ul id="answerBlock">
                    <li class="answer" id="optax"></li>
                    <li class="answer" id="optbx"></li>
                    <li class="answer" id="optcx"></li>
                    <li class="answer" id="optdx"></li>
                </ul>
                <div id="answerMsg"></div>
            </div>
        </div>
        <div id="scoring-panel" class="content-panel">
            <img alt="Panelbackground" id="scoring-back" src="assets/images/panelbackground.png"/>
            <div id="scoring"></div>
        </div>
    </div>
    <div id="menu-panel">
        <div id="standard-menu">
            <div id="introBtn" class="menuBtn activeBtn" title="Welcome Panel">
                <img alt="Info" src="assets/images/info.png"/>
            </div>
            <div id="payoffBtn" class="menuBtn" title="Payoff Panel">
                <img alt="Payoff" src="assets/images/payoff.png"/>
            </div>
            <div id="leaderboardBtn" class="menuBtn" title="Leaderboard Panel">
                <img alt="Leaderboard" src="assets/images/leaderboard.png"/>
            </div>
            <div id="profileBtn" class="menuBtn" title="About Us">
                <img alt="About" src="assets/images/about.png"/>
            </div>
            <!--<div id="profileBtn" class="menuBtn" title="About Us"></div>-->
        </div>
        <div id="answer-menu">
            <div id="opta" class="menuBtn answerBtn">A</div>
            <div id="optb" class="menuBtn answerBtn">B</div>
            <div id="optc" class="menuBtn answerBtn">C</div>
            <div id="optd" class="menuBtn answerBtn">D</div>
        </div>
        <div id="freespin-counter">
            <span id="freespin-count"></span> Free Spins Left
        </div>
    </div>
</div>
</div>

<script type="text/javascript" charset="utf-8">

var credits = gon.credits;
var won = false;
var freespins = 0;
var freespinning = false;
var freespinTotal = 0;
var winnings;
var winners = gon.winners;

function bindMenu() {
    $('#introBtn').on('click', function () {
        $('.menuBtn').removeClass('activeBtn');
        $('.content-panel').hide();
        $('#intro-panel').fadeIn();
        $('#introBtn').addClass('activeBtn');
    });
    $('#leaderboardBtn').on('click', function () {
        $('.menuBtn').removeClass('activeBtn');
        $('.content-panel').hide();
        $('#leaderboard-panel').fadeIn();
        $('#leaderboardBtn').addClass('activeBtn');
    });
    $('#payoffBtn').on('click', function () {
        $('.menuBtn').removeClass('activeBtn');
        $('.content-panel').hide();
        $('#payoff-panel').fadeIn();
        $('#payoffBtn').addClass('activeBtn');
    });
    $('#profileBtn').on('click', function () {
        $('.menuBtn').removeClass('activeBtn');
        $('.content-panel').hide();
        $('#profile-panel').fadeIn();
        $('#profileBtn').addClass('activeBtn');
    });
}
function flickSpinclick() {
    $('#spinclick').fadeIn(100, function () {
        setTimeout(function () {
            $('#spinclick').fadeOut(1000);
        }, 4000);
    });
}
function resetHandle() {
    $('#slot-handle').animate({
        left: 0
    }, 5).css({
        'pointer-events': 'auto'
    });
}
function freespinIt() {
    $('#slot-handle').animate({
        left: 0
    }, 5);
    freespins -= 1;
    setTimeout(function () {
        $('#slot-handle').trigger('click');
        $('#freespin-count').html(freespins);
    }, 1000);
}
function getWinnings(finalNumbers) {
    $.each(finalNumbers, function (index, element) {
        if (parseInt(element) > gon.iconcounts[0]) {
            finalNumbers[index] = parseInt(element) - gon.iconcounts[1];
        }
    });
    var finalArray = [];
    finalArray[0] = finalNumbers[0];
    finalArray[1] = 1;
    if (finalNumbers[0] == finalNumbers[1]) {
        finalArray[1] = 2;
        if (finalNumbers[0] == finalNumbers[2]) {
            finalArray[1] = 3;
        }
    }
    return checkWinner(finalArray);
}
function showFreeSpins(spinCount) {
    $('#answer-menu').fadeOut(function () {
        $('#freespin-count').html(freespins);
        $('#freespin-counter').fadeIn();
    });
}
function winnerAnim(creditsValue, winningValue) {
    resetHandle();
    showScore(winningValue);
}
function startSlots() {
    $('#slot-handle').animate({
        left: "-585px"
    }, 20);
    $('.slots').removeClass('winner');
    if (!freespinning) {
        updateCredits(gon.cost, "debit");
        $('.questioner').attr('src', gon.qmark_image);
    } else {
        $('.questioner').attr('src', gon.bonus_image);
    }
    if ($('#payoffBtn.activeBtn').length == 0) {
        $('#payoffBtn').trigger("click");
    }

}
function endSlots(finalNumbers) {
    if (freespinning) {
        setTimeout(function () {
            winnings = getWinnings(finalNumbers);
            freespinTotal += winnings;
            if (winnings > 0) {
                $('#free-earnings').append(" +" + winnings);
            }
            if (freespins > 0) {
                freespinIt();
            } else {
                setTimeout(function () {
                    freespinning = false;
                    resetHandle();
                    endFreeSpins();
                }, 1000);
            }
        }, 500);
    } else {
        $('#payoffTable').fadeOut();
        endNormal(finalNumbers);
    }
}
function winSlots(winCount, winners) {
    won = true;
    $.each(winners, function () {
        this.addClass('winner');
    });
    if (freespinning) {
        freespinTotal += winCount * 50;
        if (winCount > 0) {
            $('#free-earnings').append(" <span style='color:gold'>+" + winCount * 50 + "</span>");
        }
    } else {
        $('#slot-handle').css({
            'pointer-events': 'none'
        });
        // Get a Question of winCount difficulty
        $.ajax({
            url: '/askquestion/' + winCount,
            method: 'GET',
            success: function (data) {
                setTimeout(function () {
                    $('#payoff-panel').fadeOut();
                    $('#quiz-panel').fadeIn();
                    $('#standard-menu').fadeOut(function () {
                        $('#answer-menu').fadeIn();
                    });
                    $('#quiz-content').fadeIn();
                    $('#qquestion').html(data.name);
                    $('#qid').html(data.id);
                    $('#optax').html('<div class="answer-bullet" id="bulletA">A</div>' + data.opta);
                    $('#optbx').html('<div class="answer-bullet" id="bulletB">B</div>' + data.optb);
                    $('#optcx').html('<div class="answer-bullet" id="bulletC">C</div>' + data.optc);
                    $('#optdx').html('<div class="answer-bullet" id="bulletD">D</div>' + data.optd);
                    $('#answerBlock').fadeIn();
                }, 1000);
            }
        });
    }
}
function initializeSlots() {
    $('.slots').jSlots({
        number: 3,
        winnerNumber: [1, 2],
        spinner: '#slot-handle',
        easing: 'easeOutSine',
        time: 3000,
        loops: 10,
        onStart: function () {
            startSlots();
        },
        onEnd: function (finalNumbers) {
            endSlots(finalNumbers);
        },
        onWin: function (winCount, winners) {
            winSlots(winCount, winners);
        }
    });
    var clicking
}
function processAnswers(answer) {
    $.ajax({
        url: '/checkanswer/' + $('#qid').html() + '/' + answer,
        method: 'POST',
        success: function (data) {
            var resultMsg = data.split('||')[1];
            var correctAnswer = data.split('||')[2];
            freespins = parseInt(data.split('||')[0]);
            showResult(resultMsg, correctAnswer, freespins);
            setTimeout(function () {
                if (parseInt(freespins) > 0) {
                    freespinning = true;
                    showFreeSpins(freespins);
                    setTimeout(function () {
                        freespinIt();
                    }, 1000);
                } else {
                    $('#scoring-panel').fadeOut('slow');
                    $('#payoff-panel').fadeIn();
                    $('#answer-menu').fadeOut(function () {
                        $('#standard-menu').fadeIn();
                        resetHandle();
                    });
                }
            }, 3000);
        }
    });
}
function bindAnswers() {
    $('.answerBtn').on('click', function () {
        processAnswers($(this).attr("id"));
    });
    $('.answer').on('click', function () {
        processAnswers($(this).attr("id").split("x")[0]);
    });
}
function checkWinner(pattern) {
    var winnings = 0;
    $.each(winners, function (index, element) {
        if (pattern[0] == element[0] && pattern[1] == element[1]) {
            winnings = element[2];
        }
    });
    return winnings;
}
function endNormal(finalNumbers) {
    winnings = getWinnings(finalNumbers);
    updateCredits(winnings, "credit");
    winnerAnim(credits, winnings);
    setTimeout(function () {
        if (!won) {
            flickSpinclick();
            $('#payoff-panel').fadeIn('fast');
            $('#scoring-panel').fadeOut('slow');
        }
    }, 1000);

}
function showResult(resultMsg, correctAnswer, freespinsCount) {
    $('.content-panel').hide();
    $('#scoring-panel').fadeIn();
    $('#scoring').css({marginTop: "-50px"}).html("<div class='scribble'>" + resultMsg + "<br/>The correct answer is: <h3 style='color:gold;margin:0;padding:3px;'>" + correctAnswer + "</h3>You won </div>" + freespinsCount + " <div class='scribble'>free spins </div></div> ").delay(5000).animate({
        marginTop: "-100px",
        fontSize: "120px",
        opacity: 0
    }, function () {
        $('#scoring').html("<h3 style='margin:0;padding:0;color:gold'>Free Spins</h3><div class='small-scribble'> The machine will spin automatically " + freespinsCount + " times for free. Over and above the usual payoff, you will receive 50 GEOCOINS for each bonus block that appears. <h3>Earnings: <div id='free-earnings'></div></h3></div>").css({
            marginTop: "-50px",
            fontSize: "50px",
            opacity: 1
        })
    });

}
function endFreeSpins() {
    setTimeout(function () {
        $('#scoring').html("").css({
            marginTop: "0px",
            fontSize: "50px",
            opacity: 1
        })
        winnerAnim(credits, freespinTotal);
        updateCredits(freespinTotal, "credit");
        setTimeout(function () {
            $('#freespin-counter').fadeOut(function () {
                $('#standard-menu').fadeIn();
                $('#scoring-panel').fadeOut('slow');
                $('#payoff-panel').fadeIn('fast');
                freespinTotal = 0;
                won = false;
            });
            flickSpinclick();
        }, 2000);
    }, 500);
}
function showScore(winningValue) {
    $('.content-panel').fadeOut('slow');
    $('#scoring-panel').fadeIn('fast');
    $('#scoring').html("<div class='scribble'>You won</div>" + winningValue + "<div class='scribble'>GEOCOINS</div> ").delay(1500).animate({
        marginTop: "-50px",
        fontSize: "120px",
        opacity: 0
    }, function () {
        if (!won) {
            $('#scoring-panel').fadeOut('slow');
            $('#payoff-panel').fadeIn('fast');
        }
        $('#scoring').html("").css({
            marginTop: "0px",
            fontSize: "50px",
            opacity: 1
        })
    });

}
function updateCredits(payoff, txn) {
    var cTo = (txn == "debit" ? -1 : 1);
    $.ajax({
        url: '/crediting/' + gon.userid + '/' + payoff + '/' + txn,
        method: 'POST',
        success: function (data) {
            $('#creditsVal').countTo({
                from: parseInt(data) - cTo * parseInt(payoff),
                to: parseInt(data),
                speed: 1000,
                refreshInterval: 10
            });
            $('.leader-credits').html(data);
        }
    });
}


$(function () {
    initializeSlots();
    console.log("=======");
    console.log(data.customizations[0].slot_icons[0]);

    //@sloticons.each_with_index do |icon, index|
      //@winners << [index+3, 3, (6-index)*20]
      //@winners << [index+3, 2, (6-index)*10]
        //if icon.weight<2
            //@winners << [index+3, 1, (3-index)*10]
        //end
    //end

    //data coming from mygonJSON.js
    var winners = [];
    $.each(data.customizations[0].slot_icons, function(index, icon) {
        winners.push([index+3, 3, (6-index)*20]);
        winners.push([index+3, 2, (6-index)*10]);
        if (icon.weight<2){
            winners.push([index+3, 1, (3-index)*10]);
        }
    });
    console.log(winners);

    bindAnswers();
    bindMenu();
//    $('#creditsVal').countTo({
//        from: 0,
//        to: credits,
//        speed: 1000,
//        refreshInterval: 10
//    });
    flickSpinclick()
});

</script>

</body>
</html>
